<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="yet another 2FA Authenticator for HarmonyOS NEXT"><title>开发日志：Aigis Authenticator for HarmonyOS NEXT</title>
<link rel=canonical href=https://sudofree.xyz/p/developer-log-aigis-authenticator-for-harmonyos-next/><link rel=stylesheet href=/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="开发日志：Aigis Authenticator for HarmonyOS NEXT"><meta property='og:description' content="yet another 2FA Authenticator for HarmonyOS NEXT"><meta property='og:url' content='https://sudofree.xyz/p/developer-log-aigis-authenticator-for-harmonyos-next/'><meta property='og:site_name' content='My Shares and Proofs'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='HarmonyOS NEXT'><meta property='article:tag' content='2FA Authenticator'><meta property='article:tag' content='Aegis Authenticator'><meta property='article:published_time' content='2024-12-31T19:00:00+08:00'><meta property='article:modified_time' content='2024-12-31T19:00:00+08:00'><meta property='og:image' content='https://sudofree.xyz/p/developer-log-aigis-authenticator-for-harmonyos-next/screenshot-preview.png'><meta name=twitter:title content="开发日志：Aigis Authenticator for HarmonyOS NEXT"><meta name=twitter:description content="yet another 2FA Authenticator for HarmonyOS NEXT"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://sudofree.xyz/p/developer-log-aigis-authenticator-for-harmonyos-next/screenshot-preview.png'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/pika_hu14648587237871782958.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>💫</span></figure><div class=site-meta><h1 class=site-name><a href=/>My Shares and Proofs</a></h1><h2 class=site-description>Freelance Researcher & Developer.</h2></div></header><ol class=menu-social><li><a href=https://github.com/iamhyc target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://leetcode.com/u/sudo_free/ target=_blank title=LeetCode rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-leetcode"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 13h7.5"/><path d="M9.424 7.268l4.999-4.999"/><path d="M16.633 16.644l-2.402 2.415a3.189 3.189.0 01-4.524.0l-3.77-3.787a3.223 3.223.0 010-4.544l3.77-3.787a3.189 3.189.0 014.524.0l2.302 2.313"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>主页</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>链接</span></a></li><li><a href=https://resume.sudofree.xyz target=_blank><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-external-link"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 6H6A2 2 0 004 8v10a2 2 0 002 2h10a2 2 0 002-2v-6"/><path d="M11 13l9-9"/><path d="M15 4h5v5"/></svg>
<span>个人简历</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://sudofree.xyz/ selected>简体中文</option><option value=https://sudofree.xyz/en/>English</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#项目简介>项目简介</a><ol><li><a href=#开发动机>开发动机</a></li><li><a href=#设计理念>设计理念</a></li><li><a href=#特性一览>特性一览</a></li></ol></li><li><a href=#开发避坑指南>开发避坑指南</a><ol><li><a href=#开发文档的获取>开发文档的获取</a></li><li><a href=#备案与软件著作权>备案与软件著作权</a></li><li><a href=#工单系统的重要性>工单系统的重要性</a></li><li><a href=#huks-密钥管理与使用>HUKS 密钥管理与使用</a></li><li><a href=#arkts-虚拟机效率问题>ArkTS 虚拟机效率问题</a></li><li><a href=#元服务-native-开发与-native-方法调用>元服务 Native 开发与 Native 方法调用</a></li></ol></li><li><a href=#心路历程>心路历程</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/developer-log-aigis-authenticator-for-harmonyos-next/><img src=/p/developer-log-aigis-authenticator-for-harmonyos-next/screenshot-preview_hu16653717181239941744.png srcset="/p/developer-log-aigis-authenticator-for-harmonyos-next/screenshot-preview_hu16653717181239941744.png 800w, /p/developer-log-aigis-authenticator-for-harmonyos-next/screenshot-preview_hu1636999552289346652.png 1600w" width=800 height=451 loading=lazy alt="Featured image of post 开发日志：Aigis Authenticator for HarmonyOS NEXT"></a></div><div class=article-details><header class=article-category><a href=/categories/practice/ style=background-color:#ccd5ae;color:#fff>工程实践</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/developer-log-aigis-authenticator-for-harmonyos-next/>开发日志：Aigis Authenticator for HarmonyOS NEXT</a></h2><h3 class=article-subtitle>yet another 2FA Authenticator for HarmonyOS NEXT</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Dec 31, 2024</time></div></footer></div></header><section class=article-content><p><strong>前言：</strong> HarmonyOS NEXT的生态建设真是一个巨坑，特别是对于 独立开发者与开源项目 来说，更不用说元服务面对普通应用天然劣势，简直是来自审核和竞品的双重压力。但是怀着不能让新兴平台被粗制滥造的应用所淹没的信念，我还是坚持把这个项目的主要功能完成了，版本号从 v0.1.0 数到了 v1.0.0。
🎉🎉🎉 <strong>完结撒花</strong> 🎉🎉🎉</p><blockquote><p>P.S. 截至本文章发布时，Aigis Authenticator v1.0.0 仍在审核中，虽然早于12月27日上午提交审核，但大概要被拖到2025年了 😅</p></blockquote><h2 id=项目简介><a href=#%e9%a1%b9%e7%9b%ae%e7%ae%80%e4%bb%8b class=header-anchor></a>项目简介</h2><p>Aigis 是一个服务于 HarmonyOS NEXT 的 2FA 认证元服务，采用纯 ArkTS 实现，无任何三方依赖。</p><p>Aigis 的目标是成为安卓平台 <a class=link href=https://github.com/beemdevelopment/Aegis target=_blank rel=noopener>Aegis Authenticator</a> 的轻量级替代品。当前，凭借不到 300KB 的安装包大小，Aigis 已实现了其超过 90% 的功能，且实现了存储数据格式的完整兼容，可以支持加密备份文件的相互导入导出。同时，Aigis 也在设计上做了一些改进，提供了更好的用户体验和数据安全性。</p><h3 id=开发动机><a href=#%e5%bc%80%e5%8f%91%e5%8a%a8%e6%9c%ba class=header-anchor></a>开发动机</h3><p>我在 2024年9月 升级到 HarmonyOS NEXT beta 版本后，被迫放弃了大量安卓软件，以及忍受各种有缺陷的应用功能，但还是发现一个问题不能解决：<strong>没有 <a class=link href=https://github.com/beemdevelopment/Aegis target=_blank rel=noopener>Aegis Authenticator</a> 的替代品</strong>。</p><p>当时的应用市场中，只有一个叫 “手机令牌” 的丑到爆的软件（目前竟然还在更新！还是那么丑！），还不存在同类竞品<del>虽然之后卓易通的上架证明大家都是小丑🤡</del>。同时，我本来计划开发一个 RetroArch 的鸿蒙前端，<a class=link href=../retrohos-development-logs-01-migrating-libretro-cores>Retrohos</a>，正好积累一下 GUI 的开发经验。于是我在国庆假期期间，快速学习了下 HarmonyOS NEXT 的开发文档，并在 假期结束前 完成了这个项目的核心功能：OTP 计算与展示功能。在于 10月9日 提交备案审核，10月15日 过审后，我于当日上架了 Aigis 的首个测试版本。</p><h3 id=设计理念><a href=#%e8%ae%be%e8%ae%a1%e7%90%86%e5%bf%b5 class=header-anchor></a>设计理念</h3><p>Aigis 的主体设计语言参考了原版 <a class=link href=https://github.com/beemdevelopment/Aegis target=_blank rel=noopener>Aegis Authenticator</a>，同时因为元服务的形态做出了一定调整；主题配色大致参考了Aigis。</p><p><img src=/p/developer-log-aigis-authenticator-for-harmonyos-next/screenshot-preview.png width=2585 height=1456 srcset="/p/developer-log-aigis-authenticator-for-harmonyos-next/screenshot-preview_hu14353459484812509928.png 480w, /p/developer-log-aigis-authenticator-for-harmonyos-next/screenshot-preview_hu3074629423084389773.png 1024w" loading=lazy alt="Aegis Preview" class=gallery-image data-flex-grow=177 data-flex-basis=426px></p><p>主页列表条目参考了当前系统应用 <em>邮件</em> 的设计，编辑页面采用了 <a class=link href=https://github.com/beemdevelopment/Aegis target=_blank rel=noopener>Aegis Authenticator</a> 的布局方案。设置页项条目参考了系统 <em>设置</em> 的设计，优先使用了系统提供的组件范式，以保证用户体验的一致性。</p><p>Aigis Authenticator 在设计中始终把 <strong>安全</strong> 放在第一位。</p><p><img src=/p/developer-log-aigis-authenticator-for-harmonyos-next/aigis-security-design.png width=1847 height=744 srcset="/p/developer-log-aigis-authenticator-for-harmonyos-next/aigis-security-design_hu15700608592237045524.png 480w, /p/developer-log-aigis-authenticator-for-harmonyos-next/aigis-security-design_hu6614365938437409806.png 1024w" loading=lazy alt="Aigis Security Design" class=gallery-image data-flex-grow=248 data-flex-basis=595px></p><p>虽然相较于普通鸿蒙应用，元服务无法使用 Asset Kit 数据存储，系统备份，云同步等API，但这也从原理上保证了元服务的安全性：在没有网络权限的前提下，除非得到用户的许可，用户的数据无法从应用沙箱中逃逸。</p><p>相对的，在数据存储方面，Aigis 参考 <a class=link href=https://github.com/beemdevelopment/Aegis target=_blank rel=noopener>Aegis Authenticator</a> 的设计，将条目密钥存储在文件中（用户首选项）。同时，用户需要设置主密钥，并经过经典 PBKDF2 派生算法，生成 AES-256 密钥并保存在可信执行环境（TEE）中，用于条目密钥的加解密使用。</p><p>在这一数据安全存储的机制下，Aigis 通过以下的一系列安全设计，保证用户对数据的绝对掌控：</p><ul><li><p><strong>条目/密钥分离存储</strong>：在用户首选项文件中，条目和密钥分别存储，只对密钥进行加密，实现了 页面渲染效率（仅需条目）和 令牌计算（需要条目+密钥）的安全性 的平衡。在导出备份文件时，条目和密钥分别使用独立的密钥材料加密，进一步提升了数据的安全性。</p></li><li><p><strong>加密/解密密钥分离设计</strong>：得益于 HUKS 的设计，Aigis 将派生的主密钥存储在可信执行环境（TEE）中，并根据用途分为两个密钥：一个用于加密密钥（<code>enc_master_key</code>），不需要鉴权即可调用；另一个用于解密密钥（<code>dec_master_key</code>），严格限制在应用中调用，在 v2.0.0 之后支持在 ATL3 级别安全验证之后才可以调用。</p></li><li><p><strong>加密JSON文件备份</strong>：用户在设置主密钥后，可以导出加密的 JSON 格式数据文件，用于备份或者迁移到另一 Aigis 实例中。同时，用户可在 PC 或其他设备上，通过输入主密钥并调用 PBKDF2 算法，自由解密数据文件。</p></li><li><p><strong>生物识别解锁</strong>：Aigis 支持 ATL1 级别的生物识别解锁应用界面，同时允许设置 面部/指纹/PIN码 用于解锁的优先级。与 <a class=link href=https://github.com/beemdevelopment/Aegis target=_blank rel=noopener>Aegis Authenticator</a> 不同的是，Aigis 在未设置主密钥时也支持启用生物解锁，该情况下您的密钥仍以明文存储在应用沙箱中。从 v2.0.0 开始，Aigis 将支持 ATL3 级别的生物解锁，该安全性将与 <a class=link href=https://github.com/beemdevelopment/Aegis target=_blank rel=noopener>Aegis Authenticator</a> 生物解锁安全性等价。</p></li><li><p><strong>隐私窗口保护</strong>：Aigis 默认不允许截屏、屏幕录制、任意拖拽内容，以避免可能的个人信息泄露；另一方面，从 v0.8.0 版本开始，用户在设置主密钥后，可以设置禁用隐私窗口保护，以便在需要时截屏。（需要注意的是，在设置主密钥后，条目的二维码分享功能将会被自动禁用）</p></li></ul><h3 id=特性一览><a href=#%e7%89%b9%e6%80%a7%e4%b8%80%e8%a7%88 class=header-anchor></a>特性一览</h3><ul><li><p><strong>主页面列表，支持条目拖拽排序，搜索，置顶</strong></p><img src=aigis-main-page.png alt="Main Page" width=60%></li><li><p><strong>编辑页面支持 二维码分享 条目</strong></p><ul><li>仅当主密钥未设置时，设置主密钥后，分享功能将被自动禁用</li></ul></li><li><p><strong>通用/外观设置，对齐 <a class=link href=https://github.com/beemdevelopment/Aegis target=_blank rel=noopener>Aegis Authenticator</a> 界面定制需求</strong></p><img src=settings-general-outlook.png alt="General & Outlook Settings" width=60%></li><li><p><strong>支持 Aegis 格式图标包导入</strong></p><img src=settings-icon-pack.png alt="Icon Pack Import" width=60%></li><li><p><strong>主密钥设置，密码周期提醒，屏幕安全，生物识别解锁</strong></p><img src=settings-security.png alt="Security Options" width=60%></li><li><p><strong>扫码支持 Google Authenticator 二维码导入导出</strong></p><ul><li>纯 ArkTS 实现 <code>otpauth-migration</code> payload Protobuf 编解码</li></ul></li><li><p><strong>支持 <a class=link href=https://github.com/beemdevelopment/Aegis target=_blank rel=noopener>Aegis Authenticator</a> 加密备份文件导入导出</strong></p></li></ul><h2 id=开发避坑指南><a href=#%e5%bc%80%e5%8f%91%e9%81%bf%e5%9d%91%e6%8c%87%e5%8d%97 class=header-anchor></a>开发避坑指南</h2><blockquote><p>以下内容仅涉及本人在开发 Aigis 过程中摸索遇到的问题，并不全面，仅供参考。</p></blockquote><h3 id=开发文档的获取><a href=#%e5%bc%80%e5%8f%91%e6%96%87%e6%a1%a3%e7%9a%84%e8%8e%b7%e5%8f%96 class=header-anchor></a>开发文档的获取</h3><p>虽然论坛里很多吐槽开发文档不好查看，查找一个API的用法要跳转好几个页面（事实也确实如此），但是这个开发文档是和 <a class=link href=https://docs.openharmony.cn/pages/v5.0/zh-cn/application-dev/application-dev-guide.md target=_blank rel=noopener>OpenHarmony文档</a> 保持一致的，所以在查看文档时需要分清主次。</p><p>首先，<a class=link href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkui-overview-V5?catalogVersion=V5" target=_blank rel=noopener>指南</a> 和 <a class=link href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkui-overview-V5?catalogVersion=V5" target=_blank rel=noopener>API参考</a>，这两个和 OpenHarmony 保持一致，随版本号发布（虽然 OpenHarmony 网站只放出了 5.0.0 的文档，但 5.0.1 (API 13) 的文档在 <a class=link href=https://gitee.com/openharmony/docs/tree/OpenHarmony-5.0.1-Release/ target=_blank rel=noopener>gitee仓库</a> 确实是存在的）。</p><p>其次，<a class=link href="https://developer.huawei.com/consumer/cn/doc/best-practices-V5/bpta-harmonyos-features-V5?catalogVersion=V5" target=_blank rel=noopener>最佳实践</a> 和 <a class=link href="https://developer.huawei.com/consumer/cn/doc/harmonyos-faqs-V5/faqs-ux-design-V5?catalogVersion=V5" target=_blank rel=noopener>FAQ</a>，这两个是 HarmonyOS NEXT 特有的文档，更新频率会高一些（也没高多少），主要是对开发文档的缺失部分做快速的补充，但具体功能的缺陷解决和特性，目前来看还是要等上游 OpenHarmony 发版之后才能同步。另外，<a class=link href="https://developer.huawei.com/consumer/cn/doc/harmonyos-roadmap-V5/changelogs-pre-V5?catalogVersion=V5" target=_blank rel=noopener>变更预告</a> 也有一定用处，但我是看一次失望一次，反正是没修复过我提到的问题。</p><p>除此之外，在线文档页面的“智能客服”以及全局搜索功能，也有一定用处，但是不要抱太大希望，毕竟现在生态还在建设中，很多问题都是需要自己摸索。</p><h3 id=备案与软件著作权><a href=#%e5%a4%87%e6%a1%88%e4%b8%8e%e8%bd%af%e4%bb%b6%e8%91%97%e4%bd%9c%e6%9d%83 class=header-anchor></a>备案与软件著作权</h3><p><strong>关于备案</strong>：满足两个条件，单机 + 元服务，就不需要备案了；但是需要内置应用启动时弹出的“用户协议”和“隐私协议”，具体内容请参考现有应用的协议，也可以搜索论坛里的帖子，有人分享过。如果是其他情况，则一定需要备案，建议在应用启动开发时，就开始启动这个流程；这样在应用基本功能完成时，备案也差不多完成审核了。</p><p><strong>关于软件著作权</strong>：元服务不需要软件著作权，应用需要软件著作权，但也可以用电子版权证书代替；不想让代理公司赚钱，可以自己申请，但是时间要长一些。</p><h3 id=工单系统的重要性><a href=#%e5%b7%a5%e5%8d%95%e7%b3%bb%e7%bb%9f%e7%9a%84%e9%87%8d%e8%a6%81%e6%80%a7 class=header-anchor></a>工单系统的重要性</h3><p>在开发过程中，遇到疑似 API缺陷/文档缺陷 的问题，首先请在在开发者联盟论坛里搜索一下, 看看有没有人遇到过类似的问题。</p><p>如果没有的话，建议也不要再发帖了，而是直接在开发者联盟的工单系统里提交工单，这样可以更快的得到官方的回复。</p><p>虽然工单系统的回复也是千篇一律的客服复制粘贴文档，但如果问题确实存在的话，还是会上升到开发团队的视野里，有可能会得到解决。</p><p>而如果是关于应用上架遇到问题，则需要在 AppGalley Connect 的“互动中心”提交工单，这样可以更快的得到审核人员的回复。</p><h3 id=huks-密钥管理与使用><a href=#huks-%e5%af%86%e9%92%a5%e7%ae%a1%e7%90%86%e4%b8%8e%e4%bd%bf%e7%94%a8 class=header-anchor></a>HUKS 密钥管理与使用</h3><p>HUKS 的文档是存在各种缺陷的，它基于<strong>设备</strong>提供的 TEE 来实现，能力边界是和设备高度耦合的，但文档上却没体现这一点。直接影响就是，有些API在手机端根本没法用，但他们的测试却没有问题。</p><p>这里列举下我个人遇到的问题，论坛上的相关讨论是比较少的：</p><ul><li><p><strong>测试可用的</strong>：密钥导入，密钥删除，密钥覆盖创建，AES 相关加解密操作，auth鉴权访问，我这边试过都是没问题的。如有需要的话，可以参考我封装自用的工具类 <a class=link href=https://github.com/iamhyc/Aigis/blob/master/entry/src/main/ets/crypto/huksUtils.ets target=_blank rel=noopener>HUKSUtils</a>。</p></li><li><p><strong>HMAC 方法最好不要用</strong>，具体来说，也就是不要期待可以在 TEE 里完成基于 SHA1/SHA256 的，非标准密钥长度（256bit 之外）的 HMAC 操作；如果你不信的话，可以写个测试用例试试，如果能用的话也可以告诉我一声 ：）</p></li><li><p><strong>密钥派生方法：强烈建议不要使用！</strong> 首先，它只有 PBKDF2 派生算法，还不是标准实现！它的派生密钥是不能在其他设备上重复生成的，而是和TEE里的AES密钥及不可控的加密参数相关！鸿蒙使用了私有的派生算法，这个算法的安全性和可靠性都是未知的，不建议使用！</p><p>考虑到当前 ArkTS 虚拟机对于加密算法的效率问题，推荐使用 openssl 绑定的加密库，如 <a class=link href=https://ohpm.openharmony.cn/#/cn/detail/@ohos-rs%2Fopenssl target=_blank rel=noopener>@ohos-rs/openssl</a>，或者我手搓了一个 <a class=link href=https://ohpm.openharmony.cn/#/cn/detail/scrypt target=_blank rel=noopener>Scrypt</a> 密钥派生算法（仅8KB大小）。</p></li></ul><h3 id=arkts-虚拟机效率问题><a href=#arkts-%e8%99%9a%e6%8b%9f%e6%9c%ba%e6%95%88%e7%8e%87%e9%97%ae%e9%a2%98 class=header-anchor></a>ArkTS 虚拟机效率问题</h3><p>正如上面提到的，ArkTS 虚拟机对于加密算法的效率问题，是一个很大的问题。早在API 10的版本，就有人反馈过 <a class=link href="https://gitee.com/openharmony-sig/ohos_crypto_js/issues/IAS9PA?from=project-issue" target=_blank rel=noopener>@ohos/crypto-js 加解密卡死</a> 的问题，但直到目前为止，官方还没有给出解决方案。</p><p>我曾经在论坛提出这个问题，<a class=link href=https://developer.huawei.com/consumer/cn/forum/topic/0207168721096647879 target=_blank rel=noopener>ArkTS 计算密集任务（XOR运算）效率低下</a>，同时也在工单系统提问，但最后的结论是，必须把相关代码切换到 Native 实现，AOT当前是无法启用的（更不用说JIT）。</p><p>另一方面，华为也在推广 Cangjie 作为 ArkTS 的接班人，但从我的角度来看，Cangjie 的审美比 TypeScript 或者 Rust 都差远了，而且它的文档也是一团糟，API 也还没有和 ArkTS 保持一致，谁爱用谁用吧 ╮(╯▽╰)╭</p><h3 id=元服务-native-开发与-native-方法调用><a href=#%e5%85%83%e6%9c%8d%e5%8a%a1-native-%e5%bc%80%e5%8f%91%e4%b8%8e-native-%e6%96%b9%e6%b3%95%e8%b0%83%e7%94%a8 class=header-anchor></a>元服务 Native 开发与 Native 方法调用</h3><p>元服务是不允许创建 Native Module 的，也就是说不能在 元服务项目 里创建/编译含 Native 代码的 HAR/HSP module。但是，元服务可以通过引用 HAR/HSP 模块，调用 Native 方法 …… 很明显所谓不能创建 Native Module只是 DevEco Studio 的缺陷，元服务的地位之低可见一斑。</p><p>在元服务里调用 Native 方法，需要注意：对于含有 Native 模块的 HAR/HSP 模块，元服务不能通过 在线 方式引用，而需要把对应的库放在本地，然后通过本地引用的方式来调用，不然会无法找到 NAPI 暴露的方法，报错如：<code>the requested module '@normalized:Y&&&amp;libscrypt.so&' does not provide an export name 'parallelROMix' which imported by '&amp;scrypt/src/main/ets/scrypt&amp;2.0.0'</code>。
而神奇的是，对于普通应用，则完全没有这个问题。</p><p>这个问题我也提过工单了，就是到现在还没人理 😅
<img src=ticket-native-har.png alt=工单截图></p><h2 id=心路历程><a href=#%e5%bf%83%e8%b7%af%e5%8e%86%e7%a8%8b class=header-anchor></a>心路历程</h2><p>这个吐槽部分放在最后，只是来看技术的读者可以直接跳过。</p><p>2024年12月31日前，HarmonyOS NEXT的生态进展只有一个主旋律：<strong>冲量</strong>。</p><p><strong>企业开发者方面：</strong> 先是威逼利诱头部厂商，做出99%的日常应用；然后上架 卓易通/出境易 安卓虚拟机，补齐剩下的小众软件境外软件。</p><p><strong>个人开发者方面：</strong> 开发者激励计划，放出大量红利，吸引大数量应用上架（即使大部分粗制滥造），元服务上架甚至不需要软著和备案；然后再提高门槛，把上车晚的无法引流的垃圾元服务下架，省一点是一点。另一方面，官方的开发者联盟论坛直到今天为止，仍然有大量疑似官方的水军账号大量复制粘贴自导自演的发帖，把正常的虽然比较少的正常开发者的讨论与提问淹没。</p><p><strong>消费者方面：</strong> 先是发放各种合作厂商的会员月卡/季卡，再是直接送钱充话费电费交通卡；最后24年快过去了，API 14 先支持 Nova 12/13 用户升级需求，能拉一点升级率算一点。</p><p>可以看出，华为的人力和财力，都花在了<strong>在2024年结束前完成 转化率 留存率 活跃度 KPI上</strong>；至于生态的质量以及后续发展，真不好说这是否算正面的影响。</p><p>这一切的行为导向，让我在开发这个项目的时候，不断感受到无力与被歧视。首先，API 13/14 的推出，很明显是为了服务头部厂商（比如微信）的反馈（API 13），以及提高用户的升级率的需求（API 14），个人开发者反馈的问题几乎不能得到修复，比如 HUKS 的各种文档缺失以及 ArkTS 的效率低下。</p><p>其次，元服务的生态地位堪忧，虽然官方一直在强调元服务与普通应用一体两面，能给用户带来更独特的体验，但截至目前为止，元服务简介内容不能被应用市场索引，曾一度<a class=link href=https://github.com/iamhyc/Aigis/issues/30#issuecomment-2505244270 target=_blank rel=noopener>被禁止上架公开测试</a>（一个很好免费的获流渠道直到被垃圾元服务开发者滥用），不能使用鸿蒙碰一碰分享（ShareKit），不能接入意图框架，卡片加桌API存在缺陷不能触发刷新，商店审核被其他应用插队 …… 等等诸多限制，只能看出官方对元服务生态的漠视。
大概“待到山花烂漫时”，元服务也就算个肥料罢了，真不知道发的 300 块元服务优惠券到底肥了谁的钱包。</p><p>总而言之，经历了这么多波折，我还是完成了这个项目。等这波撒钱/骗钱的热度过去，再看看鸿蒙生态的未来在哪里吧，至少我现在对它是十分失望的（手持 HUAWEI Pura 70 Pro Plus 光织银 16+512GB 原价购入用户 作答 😅）。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/harmonyos-next/>HarmonyOS NEXT</a>
<a href=/tags/2fa-authenticator/>2FA Authenticator</a>
<a href=/tags/aegis-authenticator/>Aegis Authenticator</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/retrohos-development-logs-01-migrating-libretro-cores/><div class=article-image><img src=/p/retrohos-development-logs-01-migrating-libretro-cores/ppsspp-libretro-core.dee13ae4a43bda0355514c7ca3e3c041_hu10607440905720520260.png width=250 height=150 loading=lazy alt="Featured image of post Retrohos 开发日志其一: 移植 Libretro Cores" data-key=retrohos-development-logs-01-migrating-libretro-cores data-hash="md5-3uE65KQ72gNVUUx8o+PAQQ=="></div><div class=article-details><h2 class=article-title>Retrohos 开发日志其一: 移植 Libretro Cores</h2></div></a></article><article class=has-image><a href=/p/solve-memory-leak-in-vanilla-gaussian-splatting-code/><div class=article-image><img src=/p/solve-memory-leak-in-vanilla-gaussian-splatting-code/memory-leak.79b0c0ccdf97fe8d375f131e485d936c_hu5368871258442188473.png width=250 height=150 loading=lazy alt="Featured image of post 解决 Gaussian Splatting 原始实现中的内存泄漏问题" data-key=solve-memory-leak-in-vanilla-gaussian-splatting-code data-hash="md5-ebDAzN+X/o03XxMeSF2TbA=="></div><div class=article-details><h2 class=article-title>解决 Gaussian Splatting 原始实现中的内存泄漏问题</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo=iamhyc/iamhyc.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxMTEzMDI0Mjk=" data-category=Announcements data-category-id=DIC_kwDOBqJXHc4CiEQu data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=noborder_light data-lang=zh-cn data-loading crossorigin=anonymous async></script><script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"noborder_light":"noborder_dark")}})()</script><footer class=site-footer><section class=copyright>&copy;
2024 My Shares and Proofs</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.29.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>